name: SPFx CI/CD

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    env:
      TENANT_DOMAIN: wb0wj.onmicrosoft.com
      APP_CATALOG_URL: https://wb0wj.sharepoint.com/sites/appcatalog
      ADMIN_URL: https://wb0wj-admin.sharepoint.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Build SPFx solution
        run: |
          gulp bundle --ship
          gulp package-solution --ship

      - name: Install PnP PowerShell
        shell: pwsh
        run: Install-Module PnP.PowerShell -Force -Scope CurrentUser

      - name: Deploy to SharePoint App Catalog
        shell: pwsh
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        run: |
          Connect-PnPOnline `
            -Url "$env:APP_CATALOG_URL" `
            -TenantAdminUrl "$env:ADMIN_URL" `
            -ClientId "$env:CLIENT_ID" `
            -ClientSecret "$env:CLIENT_SECRET" `
            -Tenant "$env:TENANT_DOMAIN"

          Add-PnPApp `
            -Path "sharepoint/solution/your-solution.sppkg" `
            -Overwrite

          Publish-PnPApp `
            -Identity "your-solution.sppkg"
