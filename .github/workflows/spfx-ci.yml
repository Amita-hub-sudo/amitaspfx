name: SPFx CI/CD (Certificate Auth)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3Ô∏è‚É£ Install dependencies
      - name: Install npm packages
        run: npm ci

      # 4Ô∏è‚É£ Build SPFx solution
      - name: Build SPFx
        run: |
          gulp bundle --ship
          gulp package-solution --ship

      # 5Ô∏è‚É£ Install latest PnP PowerShell
      - name: Install PnP PowerShell
        shell: pwsh
        run: |
          Install-Module PnP.PowerShell -Force -Scope CurrentUser

      # 6Ô∏è‚É£ Deploy to Tenant App Catalog
      - name: Deploy to SharePoint
        shell: pwsh
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CERT_BASE64: ${{ secrets.CERT_BASE64 }}
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
        run: |

          Write-Host "üîê Decoding certificate..."

          $certBytes = [Convert]::FromBase64String($env:CERT_BASE64)
          $certPath = "$env:RUNNER_TEMP\cert.pfx"
          [IO.File]::WriteAllBytes($certPath, $certBytes)

          $securePassword = ConvertTo-SecureString $env:CERT_PASSWORD -AsPlainText -Force

          # Connect to SharePoint Admin Center first
          $adminUrl = "https://wb0wj-admin.sharepoint.com"

          Write-Host "üîó Connecting to Admin Center..."
          Connect-PnPOnline `
            -Url $adminUrl `
            -ClientId $env:CLIENT_ID `
            -Tenant $env:TENANT_ID `
            -CertificatePath $certPath `
            -CertificatePassword $securePassword

          # Get actual Tenant App Catalog URL
          $appCatalogUrl = Get-PnPTenantAppCatalogUrl
          Write-Host "üì¶ Tenant App Catalog URL: $appCatalogUrl"

          # Connect to actual App Catalog
          Write-Host "üîÑ Connecting to App Catalog..."
          Connect-PnPOnline `
            -Url $appCatalogUrl `
            -ClientId $env:CLIENT_ID `
            -Tenant $env:TENANT_ID `
            -CertificatePath $certPath `
            -CertificatePassword $securePassword

          # Find SPFx package automatically
          Write-Host "üîç Searching for .sppkg file..."
          $package = Get-ChildItem -Path "sharepoint/solution" -Filter *.sppkg | Select-Object -First 1

          if (-not $package) {
              Write-Error "‚ùå No .sppkg file found in sharepoint/solution"
              exit 1
          }

          Write-Host "‚úÖ Found package: $($package.FullName)"

          # Upload package
          Write-Host "‚¨Ü Uploading package..."
          Add-PnPApp `
            -Path $package.FullName `
            -Overwrite `
            -ErrorAction Stop

          # Publish package
          Write-Host "üöÄ Publishing package..."
          Publish-PnPApp `
            -Identity $package.Name `
            -ErrorAction Stop

          Write-Host "üéâ Deployment completed successfully."
