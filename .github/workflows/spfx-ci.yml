name: Build and Deploy SPFx to SharePoint App Catalog

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:

      # =====================================
      # Checkout Code
      # =====================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =====================================
      # Setup Node.js (FIXED TO NODE 20)
      # =====================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # =====================================
      # Install Dependencies
      # =====================================
      - name: Install dependencies
        run: |
          npm ci
          npm install -g gulp

      # =====================================
      # Build SPFx Solution
      # =====================================
      - name: Build SPFx solution
        run: |
          gulp clean
          gulp build --ship
          gulp bundle --ship
          gulp package-solution --ship

      # =====================================
      # Install CLI for Microsoft 365
      # =====================================
      - name: Install CLI for Microsoft 365
        run: npm install -g @pnp/cli-microsoft365

      # =====================================
      # Create Certificate File from Secret
      # =====================================
      - name: Create certificate file
        shell: pwsh
        run: |
          $bytes = [Convert]::FromBase64String("${{ secrets.CERT_BASE64 }}")
          [IO.File]::WriteAllBytes("cert.pfx", $bytes)

      # =====================================
      # Login to Microsoft 365
      # =====================================
      - name: Login to Microsoft 365
        run: |
          m365 login --authType certificate `
            --appId "${{ secrets.CLIENT_ID }}" `
            --tenant "wb0wj.onmicrosoft.com" `
            --certificateFile "cert.pfx" `
            --password "${{ secrets.CERT_PASSWORD }}"

      # =====================================
      # Get Generated SPPKG File
      # =====================================
      - name: Get package info
        shell: pwsh
        run: |
          $package = Get-ChildItem sharepoint/solution/*.sppkg | Select-Object -First 1
          if (-not $package) { throw "No .sppkg file found!" }

          echo "PACKAGE_NAME=$($package.Name)" >> $env:GITHUB_ENV
          echo "PACKAGE_PATH=$($package.FullName)" >> $env:GITHUB_ENV

      # =====================================
      # Upload App to Tenant App Catalog
      # =====================================
      - name: Upload to Tenant App Catalog
        run: |
          m365 spo app add `
            --filePath "${{ env.PACKAGE_PATH }}" `
            --overwrite `
            --appCatalogScope tenant

      # =====================================
      # Deploy App
      # =====================================
      - name: Deploy App
        run: |
          m365 spo app deploy `
            --name "${{ env.PACKAGE_NAME }}" `
            --appCatalogScope tenant `
            --skipFeatureDeployment true

      # =====================================
      # Logout
      # =====================================
      - name: Logout
        run: m365 logout
