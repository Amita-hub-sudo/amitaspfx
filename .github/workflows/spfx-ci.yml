name: SPFx CI/CD (Certificate Auth)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    env:
      APP_CATALOG_URL: https://wb0wj.sharepoint.com/sites/appcatalog/_layouts/15/tenantAppCatalog.aspx/manageApps

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3Ô∏è‚É£ Install dependencies
      - name: Install npm packages
        run: npm ci

      # 4Ô∏è‚É£ Build SPFx
      - name: Build SPFx
        run: |
          gulp bundle --ship
          gulp package-solution --ship

      # 5Ô∏è‚É£ Install latest PnP PowerShell
      - name: Install PnP PowerShell
        shell: pwsh
        run: |
          Install-Module PnP.PowerShell -Force -Scope CurrentUser

      # 6Ô∏è‚É£ Deploy to SharePoint
      - name: Deploy to SharePoint
        shell: pwsh
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CERT_BASE64: ${{ secrets.CERT_BASE64 }}
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
        run: |

          Write-Host "üîê Decoding certificate..."

          $certBytes = [Convert]::FromBase64String($env:CERT_BASE64)
          $certPath = "$env:RUNNER_TEMP\cert.pfx"
          [IO.File]::WriteAllBytes($certPath, $certBytes)

          $securePassword = ConvertTo-SecureString $env:CERT_PASSWORD -AsPlainText -Force

          Write-Host "üîó Connecting to SharePoint..."

          Connect-PnPOnline `
            -Url $env:APP_CATALOG_URL `
            -ClientId $env:CLIENT_ID `
            -Tenant $env:TENANT_ID `
            -CertificatePath $certPath `
            -CertificatePassword $securePassword

          Write-Host "üì¶ Searching for .sppkg file..."

          $package = Get-ChildItem -Path "sharepoint/solution" -Filter *.sppkg | Select-Object -First 1

          if (-not $package) {
              Write-Error "‚ùå No .sppkg file found in sharepoint/solution"
              exit 1
          }

          Write-Host "‚úÖ Found package: $($package.FullName)"

          Write-Host "‚¨Ü Uploading package..."

          Add-PnPApp `
            -Path $package.FullName `
            -Overwrite `
            -ErrorAction Stop

          Write-Host "üöÄ Publishing package..."

          Publish-PnPApp `
            -Identity $package.Name `
            -ErrorAction Stop

          Write-Host "üéâ Deployment completed successfully."
