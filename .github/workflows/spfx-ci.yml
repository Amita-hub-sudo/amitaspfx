name: SPFx CI/CD (Certificate Auth)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    env:
      APP_CATALOG_URL: https://wb0wj.sharepoint.com/sites/appcatalog

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Build SPFx
        run: |
          gulp bundle --ship
          gulp package-solution --ship

      - name: Install PnP PowerShell
        shell: pwsh
        run: |
          Install-Module PnP.PowerShell -Force -Scope CurrentUser

      - name: Deploy to SharePoint
        shell: pwsh
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CERT_BASE64: ${{ secrets.CERT_BASE64 }}
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
        run: |

          # Decode certificate
          $certBytes = [Convert]::FromBase64String($env:CERT_BASE64)
          $certPath = "$env:RUNNER_TEMP\cert.pfx"
          [IO.File]::WriteAllBytes($certPath, $certBytes)

          $securePassword = ConvertTo-SecureString $env:CERT_PASSWORD -AsPlainText -Force

          Connect-PnPOnline `
            -Url $env:APP_CATALOG_URL `
            -ClientId $env:CLIENT_ID `
            -Tenant $env:TENANT_ID `
            -CertificatePath $certPath `
            -CertificatePassword $securePassword

          Add-PnPApp `
            -Path "sharepoint/solution/your-solution.sppkg" `
            -Overwrite

          Publish-PnPApp `
            -Identity "your-solution.sppkg"

          Write-Host "Deployment completed successfully."
